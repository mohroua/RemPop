<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<link rel="manifest" href="/manifest.json">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“– Ø±ÙÙŠÙ‚ Ø§Ù„Ø­Ø§ÙØ¸</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00897b">
<meta name="color-scheme" content="light dark"> 
<style>
:root {
  --primary-color: #00897b;
  --secondary-color: #26a69a;
  --light-bg: #f9fdfa;
  --dark-bg: #1e272e; /* Ø®Ù„ÙÙŠØ© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† */
  --card-bg: #ffffff;
  --card-bg-dark: #2c3e50; /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© */
  --dark-text: #2c3e50;
  --white-text: #ffffff;
  --alert-color: #e74c3c;
  --focus-color: #fdd835;
  --shadow-color: rgba(0,0,0,0.1);
}
body {
  font-family: 'Tahoma','Arial',sans-serif;
  background-color: var(--light-bg);
  color: var(--dark-text);
  margin:0; padding:20px;
  text-align:center;
  direction: rtl; /* ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
  transition:background-color .4s, color .4s;
}
.dark-mode {
  background-color: var(--dark-bg);
  color: #f1f1f1;
}
.dark-mode .hifz-tool-container {
    background-color: var(--card-bg-dark);
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}
.dark-mode .input-group label {
    color: var(--secondary-color);
}
.dark-mode select, .dark-mode input {
    background-color: #444;
    color: #f1f1f1;
    border-color: #666;
}
.dark-mode .timer-display {
    background: #331f1f;
    color: var(--alert-color);
}
.dark-mode #instruction-area {
    background: #34495e;
}
.hifz-tool-container {
  max-width:600px;margin:30px auto;
  padding:30px;border-radius:15px;
  background-color:var(--card-bg);
  box-shadow:0 10px 30px var(--shadow-color);
  border-top:6px solid var(--primary-color);
}
h2 {
  color:var(--primary-color);
  margin-bottom:20px;
  font-size:1.8em;
}
.input-group{text-align:right;margin-bottom:12px;}
.input-group label{color:var(--primary-color);font-weight:bold;}
select,input{
  width:100%;padding:10px;margin-top:5px;
  border:1px solid #ccc;border-radius:8px;
}
.timer-display{
  font-size:3em;font-weight:bold;color:var(--alert-color);
  margin:20px auto;padding:15px;border:2px solid var(--alert-color);
  border-radius:12px;background:#fff3e0;
  width:max-content;
}
#instruction-area{
  background:#e0f2f1;border-right:5px solid var(--secondary-color);
  border-radius:10px;padding:15px;margin:20px 0;text-align:right;
}
.dark-mode #instruction-area #current-instruction {
    color: #f1f1f1;
}

button{
  padding:12px 20px;border:none;border-radius:30px;
  font-weight:bold;margin:5px;cursor:pointer;
  color:var(--white-text);transition:.2s;
}
button:hover{transform:scale(1.05);}
#start-btn{background:var(--primary-color);}
#recite-btn{background:#3498db;}
#reset-btn{background:var(--alert-color);}
.conf-btn{
  padding:10px 15px;margin:5px;border-radius:8px;color:white;
}
#conf-perfect{background:#2ecc71;}
#conf-partial{background:#f1c40f;}
#conf-weak{background:#c0392b;}
.mode-toggle{
  position:fixed;bottom:15px;left:15px;
  background:#444;color:white;border-radius:50%;
  width:45px;height:45px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1.2em;
  z-index: 100; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ */
}
</style>
</head>
<body>
<div class="hifz-tool-container">
  <h2>ğŸŒ¿ Ø±ÙÙŠÙ‚ Ø§Ù„Ø­Ø§ÙØ¸ ğŸ“–</h2>
  <div class="input-group">
    <label for="hifz-surah">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©:</label>
    <select id="hifz-surah"></select>
  </div>
  <div class="input-group">
    <label for="hifz-line-details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙØ¸ (Ø§Ù„ØµÙØ­Ø© ÙˆÙ†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø³Ø·Ø±):</label>
    <input id="hifz-line-details" value="Ø§Ù„Ø³Ø·Ø± 1-2 Ù…Ù† Ø§Ù„ØµÙØ­Ø©">
  </div>
  <div class="timer-display"><span id="timer-minutes">01</span>:<span id="timer-seconds">00</span></div>
  <div id="instruction-area">
    <p id="current-instruction">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†.</p>
    <p id="chunk-info">Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰: Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„ØµÙØ­Ø©</p>
  </div>
  <button id="start-btn">Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³Ø© Ø§Ù„Ø­ÙØ¸</button>
  <button id="recite-btn" disabled>â†©ï¸ Ø§Ù†ØªÙ‡ÙŠØª Ù„Ù„ØªØ³Ù…ÙŠØ¹</button>
  <button id="reset-btn" disabled>ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>

  <div id="confidence-meter" style="display:none;">
    <p><b>Ù‚ÙŠÙ‘Ù… ØªØ³Ù…ÙŠØ¹Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡:</b></p>
    <button id="conf-perfect" class="conf-btn" data-rating="3">Ø¥ØªÙ‚Ø§Ù† ØªØ§Ù… ğŸ’š</button>
    <button id="conf-partial" class="conf-btn" data-rating="2">Ø¥ØªÙ‚Ø§Ù† Ø¬Ø²Ø¦ÙŠ ğŸ’›</button>
    <button id="conf-weak" class="conf-btn" data-rating="1">Ø¶Ø¹ÙŠÙ â¤ï¸</button>
  </div>
</div>
<div class="mode-toggle" id="mode-toggle">ğŸŒ™</div>

<script>
// ======================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª =========================
const SURAHS=[
    "Ø§Ù„ÙØ§ØªØ­Ø©", "Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", "Ø§Ù„Ø£Ù†ÙØ§Ù„", "Ø§Ù„ØªÙˆØ¨Ø©", "ÙŠÙˆÙ†Ø³",
    "Ù‡ÙˆØ¯", "ÙŠÙˆØ³Ù", "Ø§Ù„Ø±Ø¹Ø¯", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", "Ø§Ù„Ø­Ø¬Ø±", "Ø§Ù„Ù†Ø­Ù„", "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", "Ø§Ù„ÙƒÙ‡Ù", "Ù…Ø±ÙŠÙ…", "Ø·Ù‡",
    "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", "Ø§Ù„Ø­Ø¬", "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„ÙØ±Ù‚Ø§Ù†", "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", "Ø§Ù„Ù†Ù…Ù„", "Ø§Ù„Ù‚ØµØµ", "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø§Ù„Ø±ÙˆÙ…",
    "Ù„Ù‚Ù…Ø§Ù†", "Ø§Ù„Ø³Ø¬Ø¯Ø©", "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", "Ø³Ø¨Ø£", "ÙØ§Ø·Ø±", "ÙŠØ³", "Ø§Ù„ØµØ§ÙØ§Øª", "Øµ", "Ø§Ù„Ø²Ù…Ø±", "ØºØ§ÙØ±",
    "ÙØµÙ„Øª", "Ø§Ù„Ø´ÙˆØ±Ù‰", "Ø§Ù„Ø²Ø®Ø±Ù", "Ø§Ù„Ø¯Ø®Ø§Ù†", "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", "Ù…Ø­Ù…Ø¯", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", "Ù‚",
    "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", "Ø§Ù„Ø·ÙˆØ±", "Ø§Ù„Ù†Ø¬Ù…", "Ø§Ù„Ù‚Ù…Ø±", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", "Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", "Ø§Ù„Ø­Ø´Ø±", "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©",
    "Ø§Ù„ØµÙ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", "Ø§Ù„ØªØºØ§Ø¨Ù†", "Ø§Ù„Ø·Ù„Ø§Ù‚", "Ø§Ù„ØªØ­Ø±ÙŠÙ…", "Ø§Ù„Ù…Ù„Ùƒ", "Ø§Ù„Ù‚Ù„Ù…", "Ø§Ù„Ø­Ø§Ù‚Ø©", "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬",
    "Ù†ÙˆØ­", "Ø§Ù„Ø¬Ù†", "Ø§Ù„Ù…Ø²Ù…Ù„", "Ø§Ù„Ù…Ø¯Ø«Ø±", "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", "Ø§Ù„Ù†Ø¨Ø£", "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", "Ø¹Ø¨Ø³",
    "Ø§Ù„ØªÙƒÙˆÙŠØ±", "Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±", "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", "Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚", "Ø§Ù„Ø¨Ø±ÙˆØ¬", "Ø§Ù„Ø·Ø§Ø±Ù‚", "Ø§Ù„Ø£Ø¹Ù„Ù‰", "Ø§Ù„ØºØ§Ø´ÙŠØ©", "Ø§Ù„ÙØ¬Ø±", "Ø§Ù„Ø¨Ù„Ø¯",
    "Ø§Ù„Ø´Ù…Ø³", "Ø§Ù„Ù„ÙŠÙ„", "Ø§Ù„Ø¶Ø­Ù‰", "Ø§Ù„Ø´Ø±Ø­", "Ø§Ù„ØªÙŠÙ†", "Ø§Ù„Ø¹Ù„Ù‚", "Ø§Ù„Ù‚Ø¯Ø±", "Ø§Ù„Ø¨ÙŠÙ†Ø©", "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª",
    "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", "Ø§Ù„ØªÙƒØ§Ø«Ø±", "Ø§Ù„Ø¹ØµØ±", "Ø§Ù„Ù‡Ù…Ø²Ø©", "Ø§Ù„ÙÙŠÙ„", "Ù‚Ø±ÙŠØ´", "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", "Ø§Ù„ÙƒÙˆØ«Ø±", "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", "Ø§Ù„Ù†ØµØ±",
    "Ø§Ù„Ù…Ø³Ø¯", "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", "Ø§Ù„ÙÙ„Ù‚", "Ø§Ù„Ù†Ø§Ø³"
];

const LEARN_TIME = 60; 
const RECITE_TIME = 60; 
const LINES_PER_PAGE = 15;

let isLearningPhase=true, timeLeft=LEARN_TIME, timerInterval, isTimerRunning=false;
let currentLine=1, totalChunks=0;

const timerMin=document.getElementById('timer-minutes');
const timerSec=document.getElementById('timer-seconds');
const startBtn=document.getElementById('start-btn');
const reciteBtn=document.getElementById('recite-btn');
const resetBtn=document.getElementById('reset-btn');
const instruction=document.getElementById('current-instruction');
const chunkInfo=document.getElementById('chunk-info');
const surahSelect=document.getElementById('hifz-surah');
const lineInput=document.getElementById('hifz-line-details');
const confMeter=document.getElementById('confidence-meter');
const confBtns=document.querySelectorAll('.conf-btn');

let selectedVoice = null; // **Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯: Ù„ØªØ®Ø²ÙŠÙ† ÙƒØ§Ø¦Ù† Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø±**

// ======================== Ø§Ù„ØµÙˆØª (Ù…Ø¹ ØªÙØ¶ÙŠÙ„ ØµÙˆØª Ø±Ø¬Ø§Ù„ÙŠ) =========================
function setArabicVoice(){
  // ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…ØªØµÙØ­ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
  const voices = speechSynthesis.getVoices();
  const arabicVoices = voices.filter(v => v.lang.startsWith('ar-'));
  
  if (arabicVoices.length > 0) {
      // Ù…Ù†Ø·Ù‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠ:
      // Ù†Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØª ÙŠØ­ØªÙˆÙŠ Ø§Ø³Ù…Ù‡ Ø¹Ù„Ù‰ 'male' Ø£Ùˆ Ø£Ø³Ù…Ø§Ø¡ Ø±Ø¬Ø§Ù„ÙŠØ© Ø´Ø§Ø¦Ø¹Ø© ÙÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª (Ù…Ø«Ù„ Ø·Ø§Ø±Ù‚ Tariq/Tarik)
      const maleVoice = arabicVoices.find(
          v => v.name.toLowerCase().includes('male') || 
               v.name.toLowerCase().includes('tarik') ||
               v.name.toLowerCase().includes('tariq')
      );
      
      // Ù†Ø®ØªØ§Ø± Ø§Ù„ØµÙˆØª Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø®ØªØ§Ø± Ø£ÙˆÙ„ ØµÙˆØª Ø¹Ø±Ø¨ÙŠ Ù…ØªØ§Ø­.
      selectedVoice = maleVoice || arabicVoices[0]; 
      // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ø±Ø¤ÙŠØ© Ø§Ø³Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… (Console)
      // console.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª: ${selectedVoice ? selectedVoice.name : 'Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'}`);
  } else {
      // console.log('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ØµÙˆØ§Øª Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.');
  }
}

function speak(text){
  if ('speechSynthesis' in window) {
    const utter=new SpeechSynthesisUtterance(text);
    utter.lang='ar-SA';
    utter.pitch=1; utter.rate=0.95;
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø± (Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØ¶Ù„)
    if (selectedVoice) {
        utter.voice = selectedVoice;
    }
    
    speechSynthesis.speak(utter);
  }
}
// =======================================================


// ======================== Ø§Ù„ØªØ®Ø²ÙŠÙ† =========================
function saveProgress(){
  localStorage.setItem('hifzProgress',JSON.stringify({
    surah:surahSelect.value,line:currentLine, totalChunks
  }));
}
function loadProgress(){
  const data=localStorage.getItem('hifzProgress');
  if(!data)return;
  const p=JSON.parse(data);
  surahSelect.value=p.surah||1;
  currentLine=p.line||1;
  totalChunks=p.totalChunks || 0;
}

// ======================== Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª =========================
function updateInstructions(){
  const surah=surahSelect.options[surahSelect.selectedIndex].text;
  const line=lineInput.value;
  if(isLearningPhase){
    instruction.innerHTML=`ğŸ’š Ù…Ø±Ø­Ù„Ø© <b>Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ù†Ø¸Ø±</b> - Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ ${line} Ù…Ù† Ø³ÙˆØ±Ø© ${surah}.`;
    chunkInfo.textContent=`Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLine}`;
  }else{
    instruction.innerHTML=`ğŸ’™ Ù…Ø±Ø­Ù„Ø© <b>Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø§Ù„ØºÙŠØ¨ÙŠ</b> - Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ØµØ­Ù ÙˆØ³Ù…Ù‘Ø¹ Ø§Ù„Ø¢Ù†.`;
    chunkInfo.textContent=`ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø³Ø·Ø± ${currentLine} Ù…Ù† Ø³ÙˆØ±Ø© ${surah}.`;
  }
}
function updateTimer(){
  timerMin.textContent=String(Math.floor(timeLeft/60)).padStart(2,'0');
  timerSec.textContent=String(timeLeft%60).padStart(2,'0');
}

// ======================== Ø§Ù„Ù…Ù†Ø·Ù‚ =========================
function startTimer(){
  if(isTimerRunning)return;
  isTimerRunning=true;
  startBtn.textContent='â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
  reciteBtn.disabled=false;
  resetBtn.disabled=false;
  surahSelect.disabled=true;
  lineInput.disabled=true;
  
  speak(isLearningPhase?'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†ØŒ Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.':'Ø§Ù„Ø¢Ù† Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ØµØ­Ù ÙˆØ³Ù…Ù‘Ø¹ ØºÙŠØ¨Ù‹Ø§.');

  timerInterval=setInterval(()=>{
    timeLeft--; updateTimer();
    if(timeLeft<=0){
      clearInterval(timerInterval);
      isTimerRunning=false;
      speak('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª.');
      
      if(isLearningPhase){
        isLearningPhase=false;
        timeLeft=RECITE_TIME;
        startBtn.textContent='Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ù…ÙŠØ¹ ğŸ—£ï¸';
        updateInstructions();
      }else{
        confMeter.style.display='block';
        startBtn.disabled=true;reciteBtn.disabled=true;
      }
    }
  },1000);
}

function handleConfidence(r){
  confMeter.style.display='none';
  if(r<=2){ // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­ÙØ¸
    speak('Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥ØªÙ‚Ø§Ù† Ø£ÙƒØ«Ø±.');
    isLearningPhase=true;timeLeft=LEARN_TIME;
    startBtn.textContent='ğŸ” Ø£Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸';startBtn.disabled=false;
  }else{ // Ø¥ØªÙ‚Ø§Ù† ÙˆØªÙ‚Ø¯Ù…
    totalChunks++;
    speak('Ø£Ø­Ø³Ù†ØªØŒ ØªØ§Ø¨Ø¹ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ.');
    
    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø¯Ù…
    if (currentLine < LINES_PER_PAGE) {
        currentLine++;
    } else {
        currentLine = 1; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ø·Ø± 1 (ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©)
        alert("âœ… ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ÙƒÙ…Ù„Øª ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© (15 Ø³Ø·Ø±Ø§Ù‹).");
    }
    
    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø§ÙƒÙ…: ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ 3 Ø£Ø¬Ø²Ø§Ø¡ Ù…ØªÙ‚Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­.
    if (totalChunks > 0 && totalChunks % 3 === 0) {
         alert(`â­ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ±Ø§ÙƒÙ…: Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ØŒ Ø³Ù…Ù‘Ø¹ Ø¢Ø®Ø± 3 Ø£Ø³Ø·Ø± Ù…ØªÙ‚Ù†Ø© Ù…Ø¹Ø§Ù‹.`);
    }

    saveProgress();
    isLearningPhase=true;timeLeft=LEARN_TIME;
    startBtn.textContent='Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ§Ù„ÙŠ ğŸš€';startBtn.disabled=false;
  }
  reciteBtn.disabled=true;
  updateInstructions();updateTimer();
}

function startRecite(){
  if(isLearningPhase){
    clearInterval(timerInterval);
    isTimerRunning=false;
    isLearningPhase=false;
    timeLeft=RECITE_TIME;updateInstructions();
    speak('Ø§Ù„Ø¢Ù† Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ØµØ­Ù ÙˆØ³Ù…Ù‘Ø¹ ØºÙŠØ¨Ù‹Ø§.');
    startBtn.textContent='Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØ³Ù…ÙŠØ¹ â–¶ï¸';
    reciteBtn.disabled = true;
  }
}

// ======================== Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ =========================
const modeToggle=document.getElementById('mode-toggle');
modeToggle.addEventListener('click',()=>{
  document.body.classList.toggle('dark-mode');
  const isDarkMode = document.body.classList.contains('dark-mode');
  modeToggle.textContent=isDarkMode?'â˜€ï¸':'ğŸŒ™';
  localStorage.setItem('darkModeEnabled', isDarkMode ? 'true' : 'false');
});

function loadDarkMode() {
    if (localStorage.getItem('darkModeEnabled') === 'true') {
        document.body.classList.add('dark-mode');
        modeToggle.textContent = 'â˜€ï¸';
    }
}

// ======================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© =========================
function populateSurahSelect() {
    SURAHS.forEach((s,i)=>{
        const o=document.createElement('option');
        o.value=i+1;o.textContent=s;surahSelect.appendChild(o);
    });
}

// **Ù…Ù‡Ù…: Ø±Ø¨Ø· Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª Ø¨Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ØªØµÙØ­**
window.speechSynthesis.onvoiceschanged = setArabicVoice;


document.addEventListener('DOMContentLoaded',()=>{
  populateSurahSelect(); // ØªÙØ¹ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  loadProgress(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…
  loadDarkMode(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†

  setArabicVoice(); // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£ØµÙˆØ§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ

  updateInstructions(); updateTimer();

  // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  surahSelect.addEventListener('change', updateInstructions);
  lineInput.addEventListener('input', updateInstructions);

  startBtn.onclick=()=>{
    if(isTimerRunning){
      clearInterval(timerInterval);
      isTimerRunning=false;
      startBtn.textContent='â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù';
    } else {
      startTimer();
    }
  };
  
  reciteBtn.onclick=startRecite;
  
  resetBtn.onclick=()=>{
    clearInterval(timerInterval);
    isTimerRunning=false;
    isLearningPhase=true;
    timeLeft=LEARN_TIME;
    currentLine=1;
    totalChunks=0;
    
    startBtn.disabled=false;
    reciteBtn.disabled=true;
    resetBtn.disabled=true;
    surahSelect.disabled=false;
    lineInput.disabled=false;
    
    confMeter.style.display='none';
    localStorage.removeItem('hifzProgress'); // Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
    
    updateInstructions();
    updateTimer();
  };
  
  confBtns.forEach(b=>b.onclick=e=>handleConfidence(parseInt(e.target.dataset.rating)));
});
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
        });
    }
</script>
</body>
</html>
